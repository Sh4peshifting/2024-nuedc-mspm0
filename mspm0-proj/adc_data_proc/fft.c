#include "fft.h"
#include "arm_const_structs.h"
#include "arm_math.h"
#include <stdio.h>

// float current_spectrum[2048];
float harmonic[16];
//frequency increasement 4.88Hz
float curr_thd;

const float hamming[] = {
    0.080000013113021851, 0.080008685588836670, 0.080034643411636353,
    0.080077946186065674, 0.080138564109802246, 0.080216467380523682,
    0.080311715602874756, 0.080424249172210693, 0.080554097890853882,
    0.080701261758804321, 0.080865681171417236, 0.081047415733337402,
    0.081246405839920044, 0.081462681293487549, 0.081696212291717529,
    0.081946998834609985, 0.082215040922164917, 0.082500308752059937,
    0.082802802324295044, 0.083122521638870239, 0.083459407091140747,
    0.083813518285751343, 0.084184795618057251, 0.084573239088058472,
    0.084978818893432617, 0.085401535034179688, 0.085841357707977295,
    0.086298286914825439, 0.086772292852401733, 0.087263375520706177,
    0.087771505117416382, 0.088296622037887573, 0.088838785886764526,
    0.089397907257080078, 0.089974015951156616, 0.090567082166671753,
    0.091177046298980713, 0.091803908348083496, 0.092447638511657715,
    0.093108206987380981, 0.093785643577575684, 0.094479858875274658,
    0.095190852880477905, 0.095918565988540649, 0.096663028001785278,
    0.097424149513244629, 0.098201990127563477, 0.098996430635452271,
    0.099807441234588623, 0.100635081529617310, 0.101479232311248779,
    0.102339893579483032, 0.103217065334320068, 0.104110658168792725,
    0.105020642280578613, 0.105947017669677734, 0.106889754533767700,
    0.107848793268203735, 0.108824074268341064, 0.109815597534179688,
    0.110823303461074829, 0.111847221851348877, 0.112887233495712280,
    0.113943308591842651, 0.115015447139739990, 0.116103559732437134,
    0.117207646369934082, 0.118327647447586060, 0.119463533163070679,
    0.120615243911743164, 0.121782749891281128, 0.122965991497039795,
    0.124164938926696777, 0.125379562377929688, 0.126609742641448975,
    0.127855539321899414, 0.129116833209991455, 0.130393594503402710,
    0.131685793399810791, 0.132993340492248535, 0.134316235780715942,
    0.135654389858245850, 0.137007772922515869, 0.138376325368881226,
    0.139760017395019531, 0.141158759593963623, 0.142572492361068726,
    0.144001245498657227, 0.145444869995117188, 0.146903336048126221,
    0.148376613855361938, 0.149864673614501953, 0.151367366313934326,
    0.152884721755981445, 0.154416650533676147, 0.155963122844696045,
    0.157523989677429199, 0.159099310636520386, 0.160688936710357666,
    0.162292867898941040, 0.163911014795303345, 0.165543317794799805,
    0.167189717292785645, 0.168850123882293701, 0.170524567365646362,
    0.172212868928909302, 0.173915028572082520, 0.175630986690521240,
    0.177360653877258301, 0.179103970527648926, 0.180860906839370728,
    0.182631343603134155, 0.184415221214294434, 0.186212480068206787,
    0.188023090362548828, 0.189846932888031006, 0.191683948040008545,
    0.193534076213836670, 0.195397287607192993, 0.197273433208465576,
    0.199162513017654419, 0.201064378023147583, 0.202979058027267456,
    0.204906404018402100, 0.206846356391906738, 0.208798885345458984,
    0.210763841867446899, 0.212741196155548096, 0.214730888605117798,
    0.216732829809188843, 0.218746960163116455, 0.220773160457611084,
    0.222811371088027954, 0.224861532449722290, 0.226923555135726929,
    0.228997379541397095, 0.231082916259765625, 0.233180046081542969,
    0.235288769006729126, 0.237408936023712158, 0.239540517330169678,
    0.241683393716812134, 0.243837505578994751, 0.246002793312072754,
    0.248179107904434204, 0.250366449356079102, 0.252564668655395508,
    0.254773706197738647, 0.256993502378463745, 0.259223937988281250,
    0.261464953422546387, 0.263716459274291992, 0.265978336334228516,
    0.268250554800033569, 0.270532995462417603, 0.272825598716735840,
    0.275128245353698730, 0.277440905570983887, 0.279763370752334595,
    0.282095700502395630, 0.284437745809555054, 0.286789357662200928,
    0.289150536060333252, 0.291521131992340088, 0.293901085853576660,
    0.296290338039398193, 0.298688769340515137, 0.301096260547637939,
    0.303512781858444214, 0.305938184261322021, 0.308372318744659424,
    0.310815274715423584, 0.313266843557357788, 0.315726935863494873,
    0.318195521831512451, 0.320672392845153809, 0.323157548904418945,
    0.325650811195373535, 0.328152209520339966, 0.330661565065383911,
    0.333178818225860596, 0.335703849792480469, 0.338236570358276367,
    0.340776890516281128, 0.343324661254882813, 0.345879912376403809,
    0.348442435264587402, 0.351012170314788818, 0.353589028120040894,
    0.356172919273376465, 0.358763724565505981, 0.361361294984817505,
    0.363965630531311035, 0.366576611995697021, 0.369194149971008301,
    0.371818065643310547, 0.374448329210281372, 0.377084851264953613,
    0.379727423191070557, 0.382376074790954590, 0.385030686855316162,
    0.387691140174865723, 0.390357315540313721, 0.393029093742370605,
    0.395706474781036377, 0.398389160633087158, 0.401077270507812500,
    0.403770625591278076, 0.406469106674194336, 0.409172594547271729,
    0.411880999803543091, 0.414594233036041260, 0.417312145233154297,
    0.420034736394882202, 0.422761827707290649, 0.425493329763412476,
    0.428229153156280518, 0.430969178676605225, 0.433713287115097046,
    0.436461418867111206, 0.439213454723358154, 0.441969275474548340,
    0.444728791713714600, 0.447491914033889771, 0.450258523225784302,
    0.453028440475463867, 0.455801665782928467, 0.458578079938888550,
    0.461357563734054565, 0.464139997959136963, 0.466925323009490967,
    0.469713360071182251, 0.472503989934921265, 0.475297212600708008,
    0.478092908859252930, 0.480890899896621704, 0.483691126108169556,
    0.486493468284606934, 0.489297837018966675, 0.492104053497314453,
    0.494912147521972656, 0.497721910476684570, 0.500533282756805420,
    0.503346145153045654, 0.506160378456115723, 0.508975863456726074,
    0.511792480945587158, 0.514610230922698975, 0.517428874969482422,
    0.520248413085937500, 0.523068726062774658, 0.525889635086059570,
    0.528711080551147461, 0.531532943248748779, 0.534355103969573975,
    0.537177503108978271, 0.540000021457672119, 0.542822539806365967,
    0.545644938945770264, 0.548467159271240234, 0.551288962364196777,
    0.554110407829284668, 0.556931376457214355, 0.559751629829406738,
    0.562571167945861816, 0.565389871597290039, 0.568207621574401855,
    0.571024239063262939, 0.573839724063873291, 0.576653957366943359,
    0.579466819763183594, 0.582278192043304443, 0.585087954998016357,
    0.587896049022674561, 0.590702235698699951, 0.593506574630737305,
    0.596308946609497070, 0.599109172821044922, 0.601907193660736084,
    0.604702830314636230, 0.607496082782745361, 0.610286712646484375,
    0.613074779510498047, 0.615860104560852051, 0.618642508983612061,
    0.621421992778778076, 0.624198436737060547, 0.626971662044525146,
    0.629741549491882324, 0.632508158683776855, 0.635271251201629639,
    0.638030767440795898, 0.640786647796630859, 0.643538653850555420,
    0.646286785602569580, 0.649030864238739014, 0.651770889759063721,
    0.654506742954254150, 0.657238245010375977, 0.659965336322784424,
    0.662687957286834717, 0.665405869483947754, 0.668119072914123535,
    0.670827507972717285, 0.673530995845794678, 0.676229476928710938,
    0.678922772407531738, 0.681610882282257080, 0.684293627738952637,
    0.686970949172973633, 0.689642786979675293, 0.692308962345123291,
    0.694969415664672852, 0.697623968124389648, 0.700272679328918457,
    0.702915251255035400, 0.705551743507385254, 0.708181977272033691,
    0.710805952548980713, 0.713423490524291992, 0.716034412384033203,
    0.718638777732849121, 0.721236348152160645, 0.723827183246612549,
    0.726411044597625732, 0.728987932205200195, 0.731557607650756836,
    0.734120130538940430, 0.736675381660461426, 0.739223182201385498,
    0.741763472557067871, 0.744296193122863770, 0.746821284294128418,
    0.749338507652282715, 0.751847863197326660, 0.754349231719970703,
    0.756842553615570068, 0.759327769279479980, 0.761804640293121338,
    0.764273166656494141, 0.766733169555664063, 0.769184768199920654,
    0.771627664566040039, 0.774061918258666992, 0.776487290859222412,
    0.778903782367706299, 0.781311273574829102, 0.783709704875946045,
    0.786098957061767578, 0.788478970527648926, 0.790849566459655762,
    0.793210744857788086, 0.795562386512756348, 0.797904372215270996,
    0.800236642360687256, 0.802559137344360352, 0.804871797561645508,
    0.807174444198608398, 0.809467077255249023, 0.811749517917633057,
    0.814021706581115723, 0.816283643245697021, 0.818535149097442627,
    0.820776164531707764, 0.823006629943847656, 0.825226426124572754,
    0.827435493469238281, 0.829633593559265137, 0.831820964813232422,
    0.833997249603271484, 0.836162567138671875, 0.838316679000854492,
    0.840459525585174561, 0.842591166496276855, 0.844711303710937500,
    0.846819996833801270, 0.848917186260223389, 0.851002693176269531,
    0.853076577186584473, 0.855138540267944336, 0.857188701629638672,
    0.859226882457733154, 0.861253082752227783, 0.863267183303833008,
    0.865269184112548828, 0.867258846759796143, 0.869236230850219727,
    0.871201157569885254, 0.873153686523437500, 0.875093698501586914,
    0.877021014690399170, 0.878935694694519043, 0.880837559700012207,
    0.882726669311523438, 0.884602785110473633, 0.886465907096862793,
    0.888316094875335693, 0.890153169631958008, 0.891976952552795410,
    0.893787562847137451, 0.895584821701049805, 0.897368729114532471,
    0.899139165878295898, 0.900896072387695313, 0.902639389038085938,
    0.904369115829467773, 0.906085014343261719, 0.907787203788757324,
    0.909475564956665039, 0.911149859428405762, 0.912810325622558594,
    0.914456725120544434, 0.916089057922363281, 0.917707204818725586,
    0.919311106204986572, 0.920900762081146240, 0.922476053237915039,
    0.924036979675292969, 0.925583422183990479, 0.927115321159362793,
    0.928632736206054688, 0.930135428905487061, 0.931623458862304688,
    0.933096706867218018, 0.934555172920227051, 0.935998797416687012,
    0.937427520751953125, 0.938841283321380615, 0.940240025520324707,
    0.941623747348785400, 0.942992329597473145, 0.944345712661743164,
    0.945683836936950684, 0.947006702423095703, 0.948314309120178223,
    0.949606478214263916, 0.950883209705352783, 0.952144503593444824,
    0.953390300273895264, 0.954620480537414551, 0.955835103988647461,
    0.957034051418304443, 0.958217322826385498, 0.959384799003601074,
    0.960536539554595947, 0.961672425270080566, 0.962792396545410156,
    0.963896512985229492, 0.964984655380249023, 0.966056764125823975,
    0.967112779617309570, 0.968152821063995361, 0.969176769256591797,
    0.970184445381164551, 0.971175968647003174, 0.972151279449462891,
    0.973110318183898926, 0.974053025245666504, 0.974979400634765625,
    0.975889444351196289, 0.976783037185668945, 0.977660179138183594,
    0.978520870208740234, 0.979364991188049316, 0.980192601680755615,
    0.981003642082214355, 0.981798052787780762, 0.982575893402099609,
    0.983337044715881348, 0.984081506729125977, 0.984809160232543945,
    0.985520243644714355, 0.986214399337768555, 0.986891865730285645,
    0.987552404403686523, 0.988196134567260742, 0.988823056221008301,
    0.989432990550994873, 0.990025997161865234, 0.990602135658264160,
    0.991161286830902100, 0.991703391075134277, 0.992228507995605469,
    0.992736697196960449, 0.993227720260620117, 0.993701756000518799,
    0.994158685207366943, 0.994598507881164551, 0.995021224021911621,
    0.995426833629608154, 0.995815277099609375, 0.996186494827270508,
    0.996540606021881104, 0.996877551078796387, 0.997197270393371582,
    0.997499704360961914, 0.997784972190856934, 0.998053073883056641,
    0.998303830623626709, 0.998537421226501465, 0.998753666877746582,
    0.998952627182006836, 0.999134361743927002, 0.999298810958862305,
    0.999445915222167969, 0.999575793743133545, 0.999688327312469482,
    0.999783575534820557, 0.999861478805541992, 0.999922096729278564,
    0.999965429306030273, 0.999991357326507568, 1.000000000000000000,
    0.999991357326507568, 0.999965429306030273, 0.999922096729278564,
    0.999861478805541992, 0.999783575534820557, 0.999688327312469482,
    0.999575793743133545, 0.999445915222167969, 0.999298810958862305,
    0.999134361743927002, 0.998952627182006836, 0.998753666877746582,
    0.998537361621856689, 0.998303830623626709, 0.998053073883056641,
    0.997784972190856934, 0.997499704360961914, 0.997197270393371582,
    0.996877551078796387, 0.996540606021881104, 0.996186494827270508,
    0.995815277099609375, 0.995426774024963379, 0.995021224021911621,
    0.994598507881164551, 0.994158685207366943, 0.993701756000518799,
    0.993227720260620117, 0.992736697196960449, 0.992228507995605469,
    0.991703391075134277, 0.991161227226257324, 0.990602135658264160,
    0.990025997161865234, 0.989432930946350098, 0.988822996616363525,
    0.988196134567260742, 0.987552404403686523, 0.986891806125640869,
    0.986214399337768555, 0.985520184040069580, 0.984809160232543945,
    0.984081506729125977, 0.983337044715881348, 0.982575893402099609,
    0.981798052787780762, 0.981003582477569580, 0.980192542076110840,
    0.979364991188049316, 0.978520810604095459, 0.977660179138183594,
    0.976782977581024170, 0.975889384746551514, 0.974979400634765625,
    0.974053025245666504, 0.973110318183898926, 0.972151279449462891,
    0.971175909042358398, 0.970184445381164551, 0.969176709651947021,
    0.968152761459350586, 0.967112779617309570, 0.966056704521179199,
    0.964984595775604248, 0.963896512985229492, 0.962792396545410156,
    0.961672365665435791, 0.960536479949951172, 0.959384799003601074,
    0.958217263221740723, 0.957033991813659668, 0.955835103988647461,
    0.954620480537414551, 0.953390240669250488, 0.952144503593444824,
    0.950883150100708008, 0.949606418609619141, 0.948314249515533447,
    0.947006702423095703, 0.945683836936950684, 0.944345593452453613,
    0.942992269992828369, 0.941623687744140625, 0.940240025520324707,
    0.938841283321380615, 0.937427520751953125, 0.935998797416687012,
    0.934555172920227051, 0.933096647262573242, 0.931623458862304688,
    0.930135369300842285, 0.928632676601409912, 0.927115321159362793,
    0.925583362579345703, 0.924036920070648193, 0.922476053237915039,
    0.920900702476501465, 0.919311046600341797, 0.917707145214080811,
    0.916088998317718506, 0.914456725120544434, 0.912810325622558594,
    0.911149859428405762, 0.909475445747375488, 0.907787203788757324,
    0.906085014343261719, 0.904369056224822998, 0.902639389038085938,
    0.900896072387695313, 0.899139165878295898, 0.897368669509887695,
    0.895584821701049805, 0.893787503242492676, 0.891976952552795410,
    0.890153050422668457, 0.888316035270690918, 0.886465907096862793,
    0.884602785110473633, 0.882726609706878662, 0.880837559700012207,
    0.878935635089874268, 0.877020955085754395, 0.875093579292297363,
    0.873153686523437500, 0.871201157569885254, 0.869236171245574951,
    0.867258787155151367, 0.865269064903259277, 0.863267183303833008,
    0.861253023147583008, 0.859226822853088379, 0.857188701629638672,
    0.855138540267944336, 0.853076457977294922, 0.851002693176269531,
    0.848917126655578613, 0.846819996833801270, 0.844711244106292725,
    0.842591047286987305, 0.840459585189819336, 0.838316679000854492,
    0.836162567138671875, 0.833997249603271484, 0.831820964813232422,
    0.829633593559265137, 0.827435374259948730, 0.825226306915283203,
    0.823006510734558105, 0.820776104927062988, 0.818535089492797852,
    0.816283583641052246, 0.814021646976470947, 0.811749458312988281,
    0.809466958045959473, 0.807174384593963623, 0.804871737957000732,
    0.802559077739715576, 0.800236582756042480, 0.797904253005981445,
    0.795562267303466797, 0.793210625648498535, 0.790849447250366211,
    0.788478791713714600, 0.786098837852478027, 0.783709526062011719,
    0.781311154365539551, 0.778903841972351074, 0.776487350463867188,
    0.774061918258666992, 0.771627724170684814, 0.769184768199920654,
    0.766733169555664063, 0.764273107051849365, 0.761804580688476563,
    0.759327650070190430, 0.756842494010925293, 0.754349172115325928,
    0.751847803592681885, 0.749338448047637939, 0.746821165084838867,
    0.744296133518218994, 0.741763412952423096, 0.739223122596740723,
    0.736675262451171875, 0.734120070934295654, 0.731557548046112061,
    0.728987812995910645, 0.726410925388336182, 0.723827064037322998,
    0.721236228942871094, 0.718638598918914795, 0.716034293174743652,
    0.713423252105712891, 0.710806012153625488, 0.708182036876678467,
    0.705551743507385254, 0.702915310859680176, 0.700272619724273682,
    0.697623968124389648, 0.694969356060028076, 0.692308902740478516,
    0.689642727375030518, 0.686970949172973633, 0.684293627738952637,
    0.681610822677612305, 0.678922712802886963, 0.676229357719421387,
    0.673530936241149902, 0.670827448368072510, 0.668119013309478760,
    0.665405750274658203, 0.662687778472900391, 0.659965217113494873,
    0.657238125801086426, 0.654506623744964600, 0.651770770549774170,
    0.649030745029449463, 0.646286606788635254, 0.643538475036621094,
    0.640786409378051758, 0.638030588626861572, 0.635271310806274414,
    0.632508218288421631, 0.629741609096527100, 0.626971602439880371,
    0.624198377132415771, 0.621421992778778076, 0.618642508983612061,
    0.615860044956207275, 0.613074779510498047, 0.610286712646484375,
    0.607496023178100586, 0.604702770709991455, 0.601907074451446533,
    0.599109113216400146, 0.596308887004852295, 0.593506515026092529,
    0.590702176094055176, 0.587895870208740234, 0.585087835788726807,
    0.582278013229370117, 0.579466700553894043, 0.576653838157653809,
    0.573839604854583740, 0.571024060249328613, 0.568207442760467529,
    0.565389692783355713, 0.562570989131927490, 0.559751451015472412,
    0.556931376457214355, 0.554110467433929443, 0.551289021968841553,
    0.548467159271240234, 0.545644938945770264, 0.542822539806365967,
    0.540000021457672119, 0.537177503108978271, 0.534355103969573975,
    0.531532883644104004, 0.528711020946502686, 0.525889575481414795,
    0.523068666458129883, 0.520248353481292725, 0.517428815364837646,
    0.514610111713409424, 0.511792421340942383, 0.508975744247436523,
    0.506160199642181396, 0.503345966339111328, 0.500533163547515869,
    0.497721791267395020, 0.494911998510360718, 0.492103934288024902,
    0.489297658205032349, 0.486493289470672607, 0.483690947294235229,
    0.480890929698944092, 0.478092938661575317, 0.475297272205352783,
    0.472504019737243652, 0.469713330268859863, 0.466925263404846191,
    0.464139997959136963, 0.461357533931732178, 0.458578050136566162,
    0.455801635980606079, 0.453028410673141479, 0.450258433818817139,
    0.447491824626922607, 0.444728732109069824, 0.441969215869903564,
    0.439213365316390991, 0.436461329460144043, 0.433713197708129883,
    0.430969059467315674, 0.428229033946990967, 0.425493210554122925,
    0.422761708498001099, 0.420034587383270264, 0.417312026023864746,
    0.414594054222106934, 0.411880791187286377, 0.409172385931015015,
    0.406468927860260010, 0.403770655393600464, 0.401077330112457275,
    0.398389220237731934, 0.395706444978713989, 0.393029093742370605,
    0.390357285737991333, 0.387691110372543335, 0.385030686855316162,
    0.382376074790954590, 0.379727393388748169, 0.377084761857986450,
    0.374448239803314209, 0.371818006038665771, 0.369194030761718750,
    0.366576552391052246, 0.363965570926666260, 0.361361205577850342,
    0.358763605356216431, 0.356172800064086914, 0.353588908910751343,
    0.351012051105499268, 0.348442316055297852, 0.345879793167114258,
    0.343324542045593262, 0.340776741504669189, 0.338236391544342041,
    0.335703670978546143, 0.333178639411926270, 0.330661594867706299,
    0.328152239322662354, 0.325650870800018311, 0.323157548904418945,
    0.320672392845153809, 0.318195462226867676, 0.315726935863494873,
    0.313266813755035400, 0.310815274715423584, 0.308372318744659424,
    0.305938124656677246, 0.303512722253799438, 0.301096230745315552,
    0.298688709735870361, 0.296290278434753418, 0.293901026248931885,
    0.291521072387695313, 0.289150446653366089, 0.286789238452911377,
    0.284437626600265503, 0.282095581293106079, 0.279763281345367432,
    0.277440756559371948, 0.275128126144409180, 0.272825479507446289,
    0.270532876253128052, 0.268250405788421631, 0.265978366136550903,
    0.263716489076614380, 0.261464953422546387, 0.259223937988281250,
    0.256993502378463745, 0.254773706197738647, 0.252564638853073120,
    0.250366419553756714, 0.248179078102111816, 0.246002733707427979,
    0.243837475776672363, 0.241683334112167358, 0.239540487527847290,
    0.237408876419067383, 0.235288679599761963, 0.233179986476898193,
    0.231082826852798462, 0.228997290134429932, 0.226923465728759766,
    0.224861443042755127, 0.222811281681060791, 0.220773071050643921,
    0.218746840953826904, 0.216732740402221680, 0.214730799198150635,
    0.212741076946258545, 0.210763722658157349, 0.208798736333847046,
    0.206846386194229126, 0.204906404018402100, 0.202979058027267456,
    0.201064407825469971, 0.199162513017654419, 0.197273403406143188,
    0.195397287607192993, 0.193534076213836670, 0.191683918237686157,
    0.189846873283386230, 0.188023030757904053, 0.186212450265884399,
    0.184415161609649658, 0.182631283998489380, 0.180860847234725952,
    0.179103940725326538, 0.177360624074935913, 0.175630927085876465,
    0.173914968967437744, 0.172212809324264526, 0.170524477958679199,
    0.168850034475326538, 0.167189627885818481, 0.165543198585510254,
    0.163910925388336182, 0.162292748689651489, 0.160688847303390503,
    0.159099191427230835, 0.157523989677429199, 0.155963122844696045,
    0.154416650533676147, 0.152884721755981445, 0.151367366313934326,
    0.149864673614501953, 0.148376613855361938, 0.146903336048126221,
    0.145444840192794800, 0.144001215696334839, 0.142572492361068726,
    0.141158729791641235, 0.139759957790374756, 0.138376295566558838,
    0.137007713317871094, 0.135654330253601074, 0.134316205978393555,
    0.132993280887603760, 0.131685733795166016, 0.130393534898757935,
    0.129116773605346680, 0.127855479717254639, 0.126609683036804199,
    0.125379472970962524, 0.124164879322052002, 0.122965902090072632,
    0.121782690286636353, 0.120615243911743164, 0.119463533163070679,
    0.118327677249908447, 0.117207646369934082, 0.116103559732437134,
    0.115015417337417603, 0.113943308591842651, 0.112887233495712280,
    0.111847192049026489, 0.110823303461074829, 0.109815597534179688,
    0.108824044466018677, 0.107848763465881348, 0.106889724731445313,
    0.105946987867355347, 0.105020612478256226, 0.104110628366470337,
    0.103217005729675293, 0.102339863777160645, 0.101479202508926392,
    0.100635051727294922, 0.099807411432266235, 0.098996371030807495,
    0.098201930522918701, 0.097424119710922241, 0.096662968397140503,
    0.095918506383895874, 0.095190793275833130, 0.094479858875274658,
    0.093785643577575684, 0.093108206987380981, 0.092447638511657715,
    0.091803908348083496, 0.091177046298980713, 0.090567082166671753,
    0.089974015951156616, 0.089397907257080078, 0.088838756084442139,
    0.088296622037887573, 0.087771475315093994, 0.087263345718383789,
    0.086772292852401733, 0.086298286914825439, 0.085841327905654907,
    0.085401535034179688, 0.084978789091110229, 0.084573209285736084,
    0.084184795618057251, 0.083813518285751343, 0.083459407091140747,
    0.083122491836547852, 0.082802772521972656, 0.082500308752059937,
    0.082215011119842529, 0.081946969032287598, 0.081696212291717529,
    0.081462681293487549, 0.081246405839920044, 0.081047415733337402,
    0.080865681171417236, 0.080701231956481934, 0.080554097890853882,
    0.080424249172210693, 0.080311715602874756, 0.080216467380523682,
    0.080138564109802246, 0.080077946186065674, 0.080034643411636353,
    0.080008685588836670
    };
    
float find_max(float *array,uint16_t start,uint16_t end)
{
    float max_value=0;
    uint16_t max_index=0;
    for(uint16_t i=start;i<end;i++){
        if(array[i]>max_value ){
            max_value=array[i];
            max_index=i;
        }
    }
    return max_value+array[max_index-1]+array[max_index+1];
}

uint16_t find_max_index(float *array,uint16_t start,uint16_t end)
{
    float max_value=0;
    uint16_t max_index=0;
    for(uint16_t i=start;i<end;i++){
        if(array[i]>max_value ){
            max_value=array[i];
            max_index=i;
        }
    }
    return max_index;
}

void curr_thd_calc()
{
    float curr_pow_sum = 0;
    float curr_sqrt = 0;
    arm_power_f32(harmonic+2, 14, &curr_pow_sum);
    arm_sqrt_f32(curr_pow_sum, &curr_sqrt);

    curr_thd = curr_sqrt / harmonic[1];

}

// void arm_hamming_f32(
//         float32_t * pDst,
//         uint32_t blockSize)
// {
//    float32_t k = 2.0f / ((float32_t) blockSize);
//    float32_t w;

//    for(uint32_t i=0;i<blockSize;i++)
//    {
//      w = 0.54f - 0.46f * cosf (PI * i * k);
//      pDst[i] = w;
//    }
// }

void fft_proc(float *input_signal)
{
    float input_cmplx[2048]={0};
    for (uint16_t i = 0; i < 1024; i++){
        input_cmplx[2*i] = input_signal[i]*hamming[i];
    }
    
    arm_cfft_f32(&arm_cfft_sR_f32_len1024 , input_cmplx , 0 , 1);
    arm_cmplx_mag_f32(input_cmplx,volt,1024);

    uint16_t base_wave_index=find_max_index(volt,3,20);
    // harmonic[1]=find_max(volt,3,20)/512/1.41421;
    for(uint16_t i=1;i<16;i++){
       harmonic[i]= find_max(volt, base_wave_index*i-3, base_wave_index*i+3) / 512 /1.41421;
    }
    curr_thd_calc();
}

